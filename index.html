<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FerriTech | Alta Performance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #0f0f0f; --bg-card: #181818; --accent-blue: #00eaff; --accent-blue-dim: rgba(0, 234, 255, 0.1); --accent-orange: #ff8c00; --text-main: #ffffff; --success: #00c851; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); padding-bottom: 50px; background-image: radial-gradient(circle at top center, #1a1a1a 0%, #0f0f0f 70%); }

        header { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); position: sticky; top: 0; z-index: 100; padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); }
        .logo-container { display: flex; align-items: center; gap: 15px; text-decoration: none; }
        .logo-img { height: 60px; width: 60px; object-fit: cover; border-radius: 50%; border: 2px solid var(--accent-blue); box-shadow: 0 0 15px var(--accent-blue-dim); }
        .logo-text { font-size: 1.5rem; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 1px; }
        .logo-text span { color: var(--accent-blue); }

        .cart-trigger { position: relative; background: linear-gradient(135deg, #222, #333); border: 1px solid #444; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .cart-count { position: absolute; top: -5px; right: -5px; background: var(--accent-orange); color: #000; font-size: 0.75rem; font-weight: 800; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .hero { text-align: center; padding: 60px 20px; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, var(--bg-dark) 100%), url('https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80') center/cover; }
        .hero h1 { font-size: 2.5rem; font-weight: 800; color: white; }
        .hero span { color: var(--accent-blue); }

        .categories-bar { background: #141414; padding: 15px 5%; border-bottom: 1px solid #222; border-top: 1px solid #222; display: flex; gap: 15px; overflow-x: auto; scrollbar-width: none; }
        .categories-bar::-webkit-scrollbar { display: none; }
        .cat-btn { background: #222; color: #aaa; border: 1px solid #333; padding: 10px 20px; border-radius: 30px; font-weight: 600; font-size: 0.9rem; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .cat-btn:hover { background: #333; color: white; }
        .cat-btn.active { background: var(--accent-blue); color: #000; border-color: var(--accent-blue); font-weight: 800; box-shadow: 0 0 15px var(--accent-blue-dim); }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; padding: 40px 5%; max-width: 1400px; margin: 0 auto; min-height: 40vh; }
        .product-card { background: var(--bg-card); border: 1px solid #2a2a2a; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; transition: 0.3s; position: relative; }
        .product-card:hover { border-color: var(--accent-blue); transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 234, 255, 0.15); }
        
        .product-img-container { height: 220px; background: #0a0a0a; padding: 0; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; overflow: hidden; }
        .product-img-container img, .product-img-container video, .product-img-container iframe { width: 100%; height: 100%; border: none; }
        .product-img-container img { object-fit: contain; }
        .product-img-container video, .product-img-container iframe { object-fit: cover; }

        .media-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: bold; z-index: 10; }
        .play-icon { position: absolute; font-size: 3rem; color: rgba(255,255,255,0.8); text-shadow: 0 0 10px rgba(0,0,0,0.5); pointer-events: none; z-index: 5; }

        .product-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .product-cat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: 800; margin-bottom: 5px; letter-spacing: 1px;}
        .product-title { font-size: 1rem; font-weight: 600; margin-bottom: 15px; color: #ddd; }
        .price { font-size: 1.6rem; color: var(--accent-blue); font-weight: 800; }
        
        .add-btn { width: 100%; padding: 14px; border: none; background: linear-gradient(90deg, #00c851, #007e33); color: white; font-weight: 700; border-radius: 8px; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; margin-top: 15px; }
        .add-btn:hover { background: linear-gradient(90deg, #00e65d, #009c3f); }

        /* CARRINHO */
        .cart-modal { position: fixed; top: 0; right: -450px; width: 100%; max-width: 420px; height: 100vh; background: var(--bg-card); z-index: 1000; transition: 0.4s; border-left: 1px solid #333; display: flex; flex-direction: column; }
        .cart-modal.open { right: 0; }
        .cart-header { padding: 25px; background: #111; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .cart-items { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .cart-footer { padding: 25px; background: #111; border-top: 1px solid #222; display: flex; flex-direction: column; gap: 15px; }
        
        .cart-input-group { display: flex; flex-direction: column; gap: 5px; }
        .cart-input-group label { font-size: 0.8rem; color: #aaa; font-weight: 600; }
        .cart-input-row { display: flex; gap: 10px; }
        .cart-input { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; outline: none; }
        .cart-input:focus { border-color: var(--accent-blue); }
        .calc-btn { padding: 10px 15px; background: var(--accent-blue); color: black; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        
        .shipping-options { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .shipping-card { background: #222; border: 1px solid #444; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .shipping-card:hover { border-color: var(--accent-blue); }
        .shipping-card input { accent-color: var(--accent-blue); transform: scale(1.2); }
        
        .cart-totals { border-top: 1px dashed #444; padding-top: 15px; display: flex; flex-direction: column; gap: 8px; }
        .cart-row { display: flex; justify-content: space-between; font-size: 0.9rem; color: #ccc; }
        .cart-row.final { font-size: 1.2rem; font-weight: 800; color: white; border-top: 1px solid #333; padding-top: 10px; margin-top: 5px; }
        .cart-row.final span:last-child { color: var(--accent-blue); font-size: 1.5rem; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(3px); z-index: 900; opacity: 0; visibility: hidden; transition: 0.3s; }
        .overlay.active { opacity: 1; visibility: visible; }
        
        /* --- GALERIA E BOT√ïES ELEGANTES --- */
        .gallery-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .gallery-container { display: flex; width: 95%; max-width: 1200px; height: 85vh; background: var(--bg-card); border-radius: 16px; overflow: hidden; box-shadow: 0 0 40px rgba(0,234,255,0.1); border: 1px solid #333; position: relative; }
        .gallery-media-section { flex: 1.5; position: relative; background: #050505; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .gallery-content { width: 100%; height: 100%; }
        .gallery-content img, .gallery-content video, .gallery-content iframe { width: 100%; height: 100%; border: none; object-fit: contain; }
        
        .gallery-info-section { flex: 1; padding: 40px 30px; display: flex; flex-direction: column; background: var(--bg-card); border-left: 1px solid #222; }
        .gallery-desc-box { color: #ccc; line-height: 1.6; font-size: 0.95rem; flex-grow: 1; white-space: pre-wrap; overflow-y: auto; padding-right: 10px; }
        .gallery-desc-box::-webkit-scrollbar { width: 6px; }
        .gallery-desc-box::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        
        .close-gallery { position: absolute; top: 20px; right: 30px; color: white; font-size: 2rem; cursor: pointer; z-index: 2001; transition: 0.3s; }
        .close-gallery:hover { color: var(--accent-orange); transform: scale(1.1); }
        
        /* BOT√ïES DE NAVEGA√á√ÉO ELEGANTES */
        .nav-btn { 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            background: rgba(20, 20, 20, 0.6); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); /* Suporte Apple */
            color: #fff; 
            border: 1px solid rgba(255,255,255,0.15); 
            width: 55px; 
            height: 55px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem; 
            cursor: pointer; 
            border-radius: 50%; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 2001; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .nav-btn:hover { 
            background: var(--accent-blue); 
            color: #000; 
            border-color: var(--accent-blue); 
            transform: translateY(-50%) scale(1.15); 
            box-shadow: 0 0 25px rgba(0, 234, 255, 0.5);
        }
        .prev-btn { left: 20px; }
        .next-btn { right: 20px; }
        /* ---------------------------------- */

        @media (max-width: 900px) {
            .gallery-container { flex-direction: column; height: 95vh; }
            .gallery-media-section { flex: 1.2; }
            .gallery-info-section { flex: 1; padding: 25px 20px; border-left: none; border-top: 1px solid #222; }
            .close-gallery { top: 10px; right: 20px; }
            .nav-btn { width: 45px; height: 45px; font-size: 1.2rem; }
            .prev-btn { left: 10px; }
            .next-btn { right: 10px; }
        }

        footer { padding: 40px; text-align: center; border-top: 1px solid #222; color: #555; font-size: 0.85rem; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .admin-link { color: #444; text-decoration: none; font-size: 0.8rem; transition: 0.3s; }
        .empty-state { grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #888; }
    </style>
</head>
<body>
    <div class="overlay" onclick="toggleCart()"></div>
    <header>
        <a href="#" class="logo-container">
            <img src="https://i.ibb.co/6R8WkFFy/unnamed-1.jpg" alt="Logo FerriTech" class="logo-img">
            <div class="logo-text">Ferri<span>Tech</span></div>
        </a>
        <div class="cart-trigger" onclick="toggleCart()">
            <i class="fas fa-shopping-bag"></i>
            <span class="cart-count" id="cart-count">0</span>
        </div>
    </header>

    <section class="hero">
        <h1>NEXT LEVEL <span>HARDWARE</span></h1>
        <p style="color: #888; margin-top: 10px;">Cariacica - ES</p>
    </section>

    <div class="categories-bar">
        <button class="cat-btn active" onclick="mudarCategoria('Destaques', this)"><i class="fas fa-star" style="color: var(--accent-orange)"></i> Destaques</button>
        <button class="cat-btn" onclick="mudarCategoria('CPU Gamer', this)">CPU Gamer</button>
        <button class="cat-btn" onclick="mudarCategoria('Processadores', this)">Processadores</button>
        <button class="cat-btn" onclick="mudarCategoria('Memorias', this)">Mem√≥rias</button>
        <button class="cat-btn" onclick="mudarCategoria('Perif√©ricos', this)">Perif√©ricos</button>
        <button class="cat-btn" onclick="mudarCategoria('Pc gamer completo', this)">PC Gamer Completo</button>
        <button class="cat-btn" onclick="mudarCategoria('Celulares', this)"><i class="fas fa-mobile-alt"></i> Celulares</button>
        <button class="cat-btn" onclick="mudarCategoria('Outros', this)">Outros</button>
    </div>

    <div class="products-grid" id="products-container">
        <p id="loading-msg" style="text-align: center; grid-column: 1/-1; padding: 50px;">A carregar hardwares de elite...</p>
    </div>

    <div class="cart-modal" id="cart-modal">
        <div class="cart-header">
            <h2><i class="fas fa-shopping-cart" style="color: var(--accent-blue);"></i> O Seu Carrinho</h2>
            <i class="fas fa-times" onclick="toggleCart()" style="cursor:pointer; font-size: 1.2rem;"></i>
        </div>
        
        <div class="cart-items" id="cart-items-container"></div>
        
        <div class="cart-footer">
            <div class="cart-input-group">
                <label><i class="fas fa-truck"></i> Calcular Frete (Correios)</label>
                <div class="cart-input-row">
                    <input type="text" id="cep-input" class="cart-input" placeholder="Seu CEP (Apenas N√∫meros)" maxlength="9">
                    <button class="calc-btn" onclick="calcularFrete()" id="btn-calcular-frete">Calcular</button>
                </div>
                <div id="shipping-options" class="shipping-options"></div> 
            </div>

            <div class="cart-totals">
                <div class="cart-row">
                    <span>Subtotal:</span>
                    <strong id="cart-subtotal">R$ 0,00</strong>
                </div>
                <div class="cart-row">
                    <span>Frete Selecionado:</span>
                    <strong id="cart-freight-value">R$ 0,00</strong>
                </div>
                <div class="cart-row final">
                    <span>Total Final:</span>
                    <span id="cart-total-final">R$ 0,00</span>
                </div>
            </div>

            <button onclick="finalizarCompra()" id="btn-finalizar" style="width:100%; padding:16px; background:#00eaff; color:black; border:none; border-radius:8px; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; font-size: 1.1rem; margin-top: 5px;">
                <i class="fas fa-lock" style="font-size: 1.2rem;"></i> PAGAR E FINALIZAR
            </button>
        </div>
    </div>

    <div class="gallery-modal" id="gallery-modal">
        <span class="close-gallery" onclick="fecharGaleria()"><i class="fas fa-times"></i></span>
        <div class="gallery-container">
            <div class="gallery-media-section">
                <button class="nav-btn prev-btn" onclick="mudarMidia(-1)"><i class="fas fa-chevron-left"></i></button>
                <div class="gallery-content" id="gallery-content"></div>
                <button class="nav-btn next-btn" onclick="mudarMidia(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="gallery-info-section">
                <div class="product-cat-label" id="gallery-cat"></div>
                <h2 id="gallery-title" style="margin-bottom: 5px; font-weight: 800; color: #fff;"></h2>
                <div class="price" id="gallery-price" style="font-size: 2rem; margin-bottom: 25px;"></div>
                <h4 style="color: #aaa; margin-bottom: 15px; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;"><i class="fas fa-info-circle"></i> Detalhes</h4>
                <div class="gallery-desc-box" id="gallery-desc"></div>
                <button class="add-btn" id="gallery-buy-btn" style="margin-top: 25px; padding: 18px; font-size: 1.1rem;"><i class="fas fa-cart-plus"></i> Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 FerriTech. Todos os direitos reservados.</p>
        <a href="login.html" class="admin-link"><i class="fas fa-lock"></i> Acesso Admin</a>
    </footer>

    <script>
        const API_BASE_URL = 'https://ferritech-api.onrender.com'; 
        let cart = [];
        let products = [];
        let categoriaAtual = 'Destaques';
        let midiaAtualIndex = 0;
        let produtoAtualMedia = [];
        
        let valorFreteSelecionado = 0;
        let nomeFreteSelecionado = "";

        document.getElementById('cep-input').addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,5})(\d{0,3})/);
            e.target.value = !x[2] ? x[1] : x[1] + '-' + x[2];
        });

        function getYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function getDriveId(url) {
            const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }

        function mudarCategoria(categoria, elementoClicado) {
            categoriaAtual = categoria;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
            elementoClicado.classList.add('active');
            renderizarProdutos();
        }

        async function carregarProdutos() {
            const cache = localStorage.getItem('ferritech_produtos_cache');
            if (cache) { products = JSON.parse(cache); renderizarProdutos(); }
            try {
                const res = await fetch(`${API_BASE_URL}/api/produtos`);
                if (!res.ok) throw new Error("Erro");
                const novosProdutos = await res.json();
                if (JSON.stringify(products) !== JSON.stringify(novosProdutos)) {
                    products = novosProdutos; localStorage.setItem('ferritech_produtos_cache', JSON.stringify(products)); renderizarProdutos();
                }
            } catch (error) { if (!cache) document.getElementById('products-container').innerHTML = `<div class="empty-state">Erro ao carregar produtos. O servidor pode estar hibernando.</div>`; }
        }

        function renderizarProdutos() {
            const container = document.getElementById('products-container');
            let produtosExibir = categoriaAtual === 'Destaques' ? products.filter(p => p.featuredOrder > 0).sort((a, b) => a.featuredOrder - b.featuredOrder) : products.filter(p => p.category === categoriaAtual);
            if (produtosExibir.length === 0) return container.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><h3>Vazio por aqui...</h3></div>`;

            container.innerHTML = produtosExibir.map(p => {
                const mainMedia = p.media && p.media.length > 0 ? p.media[0] : 'https://via.placeholder.com/300?text=Sem+Foto';
                const mediaCount = p.media ? p.media.length : 0;
                
                let mediaElement = '';
                if (getYouTubeId(mainMedia)) mediaElement = `<img src="https://img.youtube.com/vi/${getYouTubeId(mainMedia)}/hqdefault.jpg">`;
                else if (getDriveId(mainMedia)) mediaElement = `<iframe src="https://drive.google.com/file/d/${getDriveId(mainMedia)}/preview" frameborder="0" style="pointer-events: none;"></iframe>`;
                else if (mainMedia.includes('streamable.com')) mediaElement = `<iframe src="https://streamable.com/e/${mainMedia.split('/').pop()}?muted=1&autoplay=1&controls=0&nocontrols=1" style="pointer-events: none; object-fit: cover; width: 100%; height: 100%;"></iframe>`;
                else if (mainMedia.match(/\.(mp4|webm|ogg|mov)/i) || mainMedia.includes('video')) mediaElement = `<video src="${mainMedia}" autoplay muted loop playsinline style="pointer-events: none;"></video>`;
                else mediaElement = `<img src="${mainMedia}">`;

                let playIcon = getYouTubeId(mainMedia) || mainMedia.includes('streamable') ? `<i class="fas fa-play-circle play-icon"></i>` : '';
                let badge = mediaCount > 1 ? `<div class="media-badge"><i class="fas fa-images"></i> +${mediaCount - 1}</div>` : '';
                
                return `
                <div class="product-card">
                    <div class="product-img-container" onclick="abrirGaleria('${p.id}')">${mediaElement}${playIcon}${badge}</div>
                    <div class="product-info">
                        <div><div class="product-cat-label">${p.category||'Outros'}</div><h3 class="product-title">${p.name}</h3></div>
                        <div class="price">R$ ${p.price.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        <button class="add-btn" onclick="addToCart('${p.id}')"><i class="fas fa-cart-plus"></i> Comprar</button>
                    </div>
                </div>`;
            }).join('');
        }

        function abrirGaleria(id) {
            const p = products.find(i => i.id == id);
            produtoAtualMedia = p.media; midiaAtualIndex = 0; 
            document.getElementById('gallery-cat').innerText = p.category || 'Outros';
            document.getElementById('gallery-title').innerText = p.name;
            document.getElementById('gallery-price').innerText = `R$ ${p.price.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('gallery-desc').innerHTML = p.description ? p.description.replace(/\n/g, '<br>') : '';
            document.getElementById('gallery-buy-btn').onclick = () => { addToCart(p.id); fecharGaleria(); };
            atualizarGaleriaVisual(); document.getElementById('gallery-modal').style.display = 'flex';
        }
        function fecharGaleria() { document.getElementById('gallery-modal').style.display = 'none'; document.getElementById('gallery-content').innerHTML = ''; }
        function mudarMidia(direcao) { midiaAtualIndex += direcao; if(midiaAtualIndex < 0) midiaAtualIndex = produtoAtualMedia.length - 1; if(midiaAtualIndex >= produtoAtualMedia.length) midiaAtualIndex = 0; atualizarGaleriaVisual(); }
        
        // --- FUN√á√ÉO CORRIGIDA PARA LER STREAMABLE ---
        function atualizarGaleriaVisual() {
            const mediaUrl = produtoAtualMedia[midiaAtualIndex]; 
            const container = document.getElementById('gallery-content');
            const ytId = getYouTubeId(mediaUrl);
            const driveId = getDriveId(mediaUrl);

            if (ytId) {
                container.innerHTML = `<iframe src="https://www.youtube.com/embed/${ytId}?autoplay=1" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width: 100%; height: 100%; border: none;"></iframe>`;
            } else if (driveId) {
                container.innerHTML = `<iframe src="https://drive.google.com/file/d/${driveId}/preview" allowfullscreen style="width: 100%; height: 100%; border: none;"></iframe>`;
            } else if (mediaUrl.includes('streamable.com')) {
                const streamId = mediaUrl.split('/').pop();
                container.innerHTML = `<iframe src="https://streamable.com/e/${streamId}?autoplay=1" allowfullscreen style="width: 100%; height: 100%; border: none;"></iframe>`;
            } else if (mediaUrl.match(/\.(mp4|webm|ogg|mov)/i) || mediaUrl.includes('video')) {
                container.innerHTML = `<video src="${mediaUrl}" autoplay controls playsinline style="width: 100%; height: 100%; object-fit: contain;"></video>`;
            } else {
                container.innerHTML = `<img src="${mediaUrl}" alt="M√≠dia" style="width: 100%; height: 100%; object-fit: contain;">`;
            }
        }

        async function calcularFrete() {
            if(cart.length === 0) return alert("Adicione produtos primeiro!");
            const cepDigitado = document.getElementById('cep-input').value;
            const btn = document.getElementById('btn-calcular-frete');
            const optionsBox = document.getElementById('shipping-options');
            if(cepDigitado.length < 8) return alert("CEP Incompleto");

            btn.innerText = "Aguarde..."; btn.disabled = true;
            const pesoTotal = cart.reduce((sum, item) => sum + (item.weight || 1.0), 0);

            try {
                const res = await fetch(`${API_BASE_URL}/api/frete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cepDestino: cepDigitado, pesoTotal: pesoTotal })
                });
                
                const data = await res.json();
                
                if (data.success && data.pac && data.sedex) {
                    const valorPac = parseFloat(data.pac.Valor.replace(',', '.'));
                    const valorSedex = parseFloat(data.sedex.Valor.replace(',', '.'));

                    optionsBox.innerHTML = `
                        <label class="shipping-card">
                            <input type="radio" name="frete" value="${valorPac}" onchange="selecionarFrete(this, 'PAC')">
                            <div style="flex-grow: 1;">
                                <strong style="color: white; display: block;">PAC - R$ ${valorPac.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>
                                <small style="color: #888;">Prazo: ${data.pac.PrazoEntrega} dias √∫teis</small>
                            </div>
                        </label>
                        <label class="shipping-card">
                            <input type="radio" name="frete" value="${valorSedex}" onchange="selecionarFrete(this, 'SEDEX')">
                            <div style="flex-grow: 1;">
                                <strong style="color: var(--accent-blue); display: block;">SEDEX - R$ ${valorSedex.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>
                                <small style="color: #888;">Prazo: ${data.sedex.PrazoEntrega} dias √∫teis</small>
                            </div>
                        </label>
                    `;
                } else { optionsBox.innerHTML = `<span style="color: #ff4444">N√£o foi poss√≠vel calcular o frete.</span>`; }
            } catch(e) { optionsBox.innerHTML = `<span style="color: #ff4444">Erro de conex√£o com os Correios.</span>`; }
            btn.innerText = "Calcular"; btn.disabled = false;
        }

        function selecionarFrete(radioElement, nomeTransporte) {
            valorFreteSelecionado = parseFloat(radioElement.value);
            nomeFreteSelecionado = nomeTransporte;
            atualizarCarrinho();
        }

        function addToCart(id) {
            const p = products.find(item => item.id == id);
            if (p) { cart.push(p); atualizarCarrinho(); openCart(); }
        }

        function atualizarCarrinho() {
            document.getElementById('cart-count').innerText = cart.length;
            const container = document.getElementById('cart-items-container');
            
            if (cart.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:#555; margin-top:20px;">Carrinho vazio.</p>`;
                document.getElementById('shipping-options').innerHTML = "";
                valorFreteSelecionado = 0; nomeFreteSelecionado = "";
            } else {
                container.innerHTML = cart.map((item, idx) => `
                    <div style="padding:15px; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center">
                        <div>
                            <p style="font-size:0.9rem; font-weight:600">${item.name}</p>
                            <p style="color:var(--accent-blue)">R$ ${item.price.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        </div>
                        <i class="fas fa-trash" onclick="removerItem(${idx})" style="color:#ff4444; cursor:pointer; padding: 5px;"></i>
                    </div>
                `).join('');
            }
            
            const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            const totalFinal = cart.length > 0 ? subtotal + valorFreteSelecionado : 0;
            
            document.getElementById('cart-subtotal').innerText = `R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('cart-freight-value').innerText = `R$ ${valorFreteSelecionado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('cart-total-final').innerText = `R$ ${totalFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        function removerItem(index) { cart.splice(index, 1); atualizarCarrinho(); }
        function toggleCart() { document.getElementById('cart-modal').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('active'); }
        function openCart() { document.getElementById('cart-modal').classList.add('open'); document.querySelector('.overlay').classList.add('active'); }

        async function finalizarCompra() {
            if (cart.length === 0) return alert("O carrinho est√° vazio!");
            if (document.getElementById('shipping-options').innerHTML !== "" && valorFreteSelecionado === 0) {
                return alert("Por favor, selecione uma op√ß√£o de frete!");
            }

            const btnFinalizar = document.getElementById('btn-finalizar');
            btnFinalizar.innerText = "Processando...";
            btnFinalizar.disabled = true;

            try {
                const res = await fetch(`${API_BASE_URL}/api/checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: cart,
                        shippingPrice: valorFreteSelecionado,
                        shippingName: nomeFreteSelecionado
                    })
                });

                const data = await res.json();

                if (data.success && data.init_point) {
                    let itensTxt = cart.map(i => `‚úÖ ${i.name}`).join('%0A');
                    const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
                    const totalGeral = subtotal + valorFreteSelecionado;
                    
                    let zapMsg = `*üöÄ NOVO PEDIDO - A CAMINHO DO PAGAMENTO*%0A%0A`;
                    zapMsg += `*Itens:*%0A${itensTxt}%0A%0A`;
                    zapMsg += `*Frete:* ${nomeFreteSelecionado} - R$ ${valorFreteSelecionado.toFixed(2)}%0A`;
                    zapMsg += `*Total a Pagar:* R$ ${totalGeral.toFixed(2)}%0A%0A`;
                    zapMsg += `_O cliente j√° est√° na tela do Mercado Pago finalizando a compra via site._`;

                    window.open(`https://wa.me/5527995809348?text=${zapMsg}`, '_blank');
                    
                    setTimeout(() => {
                        window.location.href = data.init_point;
                    }, 1000);

                } else {
                    alert("Erro ao conectar com Mercado Pago. Tente novamente.");
                    btnFinalizar.innerText = "PAGAR E FINALIZAR";
                    btnFinalizar.disabled = false;
                }
            } catch (err) {
                alert("Erro de conex√£o.");
                btnFinalizar.innerText = "PAGAR E FINALIZAR";
                btnFinalizar.disabled = false;
            }
        }

        carregarProdutos();
    </script>
</body>
</html>
